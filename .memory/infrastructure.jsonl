{"type":"entity","name":"deploy-2026-02-04-integration","entityType":"deployment","observations":["Worker deployed to Cloudflare Workers successfully","Dashboard deployed to Cloudflare Pages successfully","Version ID: a8ee9fde-b8e8-4c58-b09e-749d0b8c14cd","Changes: Integrated distributed CLAUDE.md + Agents + Skills + MCP servers","Created 8 distributed CLAUDE.md files across source folders","Created 4 MCP usage skills (cloudflare, memory, github, playwright)","Updated 6 agents with MCP Tools sections","Created 7 slash commands for common tasks","Fixed test expectations (27 tools, removed n8n_list_credentials)","All pre-deploy checks passed (TypeScript, tests)","Health check verified: https://n8n-management-mcp.node2flow.net/","Plans endpoint verified: https://n8n-management-mcp.node2flow.net/api/plans"]}
{"type":"entity","name":"Node2Flow-MCP-service","entityType":"project","observations":["Monorepo for centralized SaaS MCP platform using Turborepo + pnpm workspaces","GitHub repo: https://github.com/kaewz-manga/Node2Flow-MCP-service","Local path: D:\\Dev\\playground\\Claude_Code_Commander\\Node2Flow-MCP-service\\","Architecture: 2 Workers (Platform + MCP Gateway) + 1 Dashboard","Plugin Architecture: เพิ่ม product ใหม่ = 4 ไฟล์ใน plugins/ folder","Phase 1 skeleton pushed to GitHub on 2026-02-06","Plan document: docs/PLATFORM_PLAN.md"]}
{"type":"entity","name":"Platform-Worker","entityType":"cloudflare-worker","observations":["Central auth, billing, user management, admin panel Worker","Path: apps/platform-worker/ in Node2Flow-MCP-service monorepo","Will deploy to: platform.node2flow.net","Handles: /api/auth/*, /api/user/*, /api/billing/*, /api/admin/*, /internal/*","D1: node2flow-platform-db (users, plans, api_keys, usage_logs, admin_logs)","KV: RATE_LIMIT_KV + OAUTH_STATE_KV","Status: Phase 1 skeleton created, routes not implemented yet"]}
{"type":"entity","name":"MCP-Gateway-Worker","entityType":"cloudflare-worker","observations":["MCP Gateway Worker - all products as plugins in a single Worker","Path: apps/mcp-gateway/ in Node2Flow-MCP-service monorepo","Will deploy to: mcp.node2flow.net","Plugin Architecture: MCPPlugin interface with id, tools, createClient, handleToolCall","Plugin Registry: Map<string, MCPPlugin> in plugin-registry.ts","Unified connections table: product_type column + encrypted JSON config","Service Binding to Platform Worker (0ms latency)","D1: node2flow-products-db (connections table for all products)","Bundle size estimate: 10 plugins ~500KB, limit 10MB","Status: Phase 1 skeleton + n8n plugin placeholder created"]}
{"type":"entity","name":"Node2Flow-Plugin-Architecture","entityType":"architecture-pattern","observations":["เพิ่ม product ใหม่ = 4 ไฟล์: tools.ts, client.ts, types.ts, index.ts + 1 บรรทัด import","MCPPlugin interface: id, name, version, tools[], createClient(), handleToolCall()","Plugin template at: apps/mcp-gateway/src/plugins/_template/","n8n plugin placeholder at: apps/mcp-gateway/src/plugins/n8n/","Unified connections table: 1 table ใช้ product_type column + encrypted JSON config","ไม่ต้องแก้ MCP handler, auth, connections CRUD, rate limiting เมื่อเพิ่ม plugin ใหม่"]}
{"type":"entity","name":"Node2Flow-Security-Model","entityType":"security-design","observations":["JWT (Dashboard): เข้าได้ทุก product - ปกติสำหรับ SaaS (เหมือน Google login)","API Key n2f_xxx: แต่ละ key ผูกกับ 1 connection เท่านั้น - key หลุดเสียแค่ 1 connection","ไม่มี super key ที่เข้าถึงทุก product","JWT ลดเสี่ยงด้วย: expiration + TOTP 2FA + revoke session","SSO: JWT shared secret ระหว่าง Platform Worker + MCP Gateway Worker","External products (Vercel/VPS): ใช้ HMAC-signed HTTP เรียก /internal/validate-token"]}
{"type":"entity","name":"Node2Flow-Billing","entityType":"billing-design","observations":["Plan เดียว pooled ข้าม product: Free($0)/Pro($19)/Enterprise(Custom)","Rate limits pooled: Free 100 req/day, Pro 5000 req/day","Usage tracking centralized ที่ Platform Worker (product_id column แยก)","KV rate limit key: daily:{userId}:{date} (ไม่แยก product)","Dashboard แสดง usage breakdown แยก product ได้ (GROUP BY product_id)","Stripe integration อยู่ที่ Platform Worker เท่านั้น"]}
{"type":"entity","name":"Node2Flow-Migration-Plan","entityType":"migration-plan","observations":["6 Phases รวม ~10-14 วัน ทำทีละ phase verify ก่อนไป phase ถัดไป","Phase 1: Monorepo Shell - DONE (pushed 2026-02-06)","Phase 2: Extract Shared Code → packages/ (2-3 วัน)","Phase 3: Refactor เป็น Plugin Architecture (2-3 วัน)","Phase 4: สร้าง Platform Worker (3-4 วัน)","Phase 5: Data Migration + Switchover (1-2 วัน, HIGH RISK)","Phase 6: Dashboard + DNS Cutover (1 วัน)","n8n-management-mcp ยังทำงานปกติตลอดการ migration ไม่ downtime"]}
{"type":"entity","name":"node2flow-mcp-service","entityType":"project","observations":["Repo: https://github.com/kaewz-manga/Node2Flow-MCP-service","Local: D:\\Dev\\playground\\Claude_Code_Commander\\Node2Flow-MCP-service\\","Monorepo: Turborepo + pnpm workspaces","Architecture: 2 Workers (Platform + MCP Gateway) + Plugin Architecture","Source of truth: n8n-management-mcp (untouched, still running)","Total: 50 files, ~9,062 lines across 5 phases"]}
{"type":"entity","name":"phase-1-monorepo-skeleton","entityType":"deployment","observations":["Commit: 12bbc4b - feat: init monorepo with Plugin Architecture skeleton","Created turbo.json, pnpm-workspace.yaml, tsconfig.base.json","Created empty app shells: platform-worker, mcp-gateway, dashboard","Created empty package shells: platform-core, dashboard-core","Status: DONE"]}
{"type":"entity","name":"phase-2-extract-shared-code","entityType":"deployment","observations":["Commit: a694762 - feat: Phase 2 - Extract shared code into platform-core and dashboard-core","Extracted auth.ts, crypto-utils.ts, oauth.ts, stripe.ts, email.ts → platform-core","Extracted db operations into 6 modules (users, plans, api-keys, usage, connections, admin)","Extracted React components → dashboard-core (Layout, AuthContext, SudoContext, etc.)","Created types/platform.ts with all TypeScript interfaces","Status: DONE"]}
{"type":"entity","name":"phase-3-plugin-architecture","entityType":"deployment","observations":["Commit: 296f3c1 - feat: Phase 3 - Refactor into Plugin Architecture","Created MCPPlugin interface + plugin-registry.ts","Moved n8n code into plugins/n8n/ (client.ts, tools.ts, types.ts, index.ts = 31 tools)","Created unified connections table with product_type column","Created MCP JSON-RPC 2.0 handler (routes/mcp.ts)","Created Gateway auth via Platform service binding (routes/auth.ts)","Created connections CRUD with AES-256-GCM encryption (routes/connections.ts)","Status: DONE"]}
{"type":"entity","name":"phase-4-platform-worker","entityType":"deployment","observations":["Commit: 0091d5c - feat: Phase 4 - Build Platform Worker with all routes","Created 6 route modules: auth, user, admin, billing, internal, agent","Consolidated 10 old migrations → 001_platform_schema.sql (10 tables)","Internal API for Gateway service binding: validate-api-key, validate-token, report-usage, check-limits","Fixed platform-core imports (saas-types → types/platform)","Enabled all barrel exports in platform-core (auth, oauth, stripe, email)","Total: 16 files, 1,662 lines added","Status: DONE"]}
{"type":"entity","name":"phase-5-data-migration","entityType":"deployment","observations":["Commit: 2d11b46 - feat: Phase 5 - Data migration + switchover","Removed n8n_connections from Platform DB (connections live in Gateway)","Removed connection CRUD from Platform user.ts (Gateway handles these)","Removed connection FK from api_keys (cross-DB reference)","Added usage reporting in Gateway mcp.ts via ctx.waitUntil → Platform /internal/report-usage","Fixed tools/list to use getPlugin() instead of findPluginForTool()","Created scripts/migrate-data.sql and scripts/migrate-connections.ts","Admin user detail shows API keys instead of connections","Status: DONE"]}
{"type":"entity","name":"phase-6-dashboard-cutover","entityType":"feature","observations":["Status: TODO - Not started","Dashboard API split: auth/billing → Platform, connections/proxy → Gateway","Update api.ts → platform-api.ts + gateway-api.ts","Dashboard plugin system: move n8n pages → plugins/n8n/, React.lazy() code-split","DNS: platform.node2flow.net, mcp.node2flow.net, app.node2flow.net","Update OAuth redirect URLs + Stripe webhook URL","Deploy: create D1 databases, set secrets, run migrations, deploy Workers + Pages","Keep old endpoints redirect 30 days"]}
{"type":"entity","name":"decision-2-workers-architecture","entityType":"decision","observations":["Decided: 2 Workers only (Platform + Gateway) regardless of product count","Alternative: 1 Worker per product (rejected - 10+ Workers to manage)","Alternative: Single Worker (rejected - too coupled, hard to maintain)","Trade-off: Gateway bundle grows with plugins but 10 plugins ~500KB << 10MB limit","Service Binding: Gateway → Platform for auth/usage (0ms latency, internal-only)"]}
{"type":"entity","name":"decision-plugin-architecture","entityType":"decision","observations":["Decided: Plugin Architecture - 4 files per product, 1 line registration","Files: index.ts (registration), tools.ts (MCP tools), client.ts (HTTP), types.ts (config schema)","Unified connections table: 1 table with product_type column + encrypted JSON config","No core changes needed when adding new products","Each product defines own connection config schema via encrypted JSON"]}
{"type":"entity","name":"decision-data-split","entityType":"decision","observations":["Platform DB: users, plans, api_keys, usage_logs, usage_monthly, platform_stats, admin_logs, ai_connections, bot_connections, feedback","Gateway DB: connections (unified, product_type column)","api_keys.connection_id is cross-DB reference (no FK enforcement)","Platform validates API key + user + rate limits, Gateway validates connection existence","Pooled billing: plan limits shared across all products"]}
{"type":"relation","from":"Node2Flow-MCP-service","to":"Platform-Worker","relationType":"contains"}
{"type":"relation","from":"Node2Flow-MCP-service","to":"MCP-Gateway-Worker","relationType":"contains"}
{"type":"relation","from":"Node2Flow-MCP-service","to":"Node2Flow-Plugin-Architecture","relationType":"uses"}
{"type":"relation","from":"Node2Flow-MCP-service","to":"Node2Flow-Security-Model","relationType":"implements"}
{"type":"relation","from":"Node2Flow-MCP-service","to":"Node2Flow-Billing","relationType":"implements"}
{"type":"relation","from":"Node2Flow-MCP-service","to":"Node2Flow-Migration-Plan","relationType":"follows"}
{"type":"relation","from":"MCP-Gateway-Worker","to":"Platform-Worker","relationType":"calls_via_service_binding"}
{"type":"relation","from":"MCP-Gateway-Worker","to":"Node2Flow-Plugin-Architecture","relationType":"implements"}
{"type":"relation","from":"Node2Flow-MCP-service","to":"n8n-management-mcp","relationType":"replaces"}
{"type":"relation","from":"phase-1-monorepo-skeleton","to":"node2flow-mcp-service","relationType":"belongs_to"}
{"type":"relation","from":"phase-2-extract-shared-code","to":"node2flow-mcp-service","relationType":"belongs_to"}
{"type":"relation","from":"phase-3-plugin-architecture","to":"node2flow-mcp-service","relationType":"belongs_to"}
{"type":"relation","from":"phase-4-platform-worker","to":"node2flow-mcp-service","relationType":"belongs_to"}
{"type":"relation","from":"phase-5-data-migration","to":"node2flow-mcp-service","relationType":"belongs_to"}
{"type":"relation","from":"phase-6-dashboard-cutover","to":"node2flow-mcp-service","relationType":"belongs_to"}
{"type":"relation","from":"phase-2-extract-shared-code","to":"phase-1-monorepo-skeleton","relationType":"depends_on"}
{"type":"relation","from":"phase-3-plugin-architecture","to":"phase-2-extract-shared-code","relationType":"depends_on"}
{"type":"relation","from":"phase-4-platform-worker","to":"phase-3-plugin-architecture","relationType":"depends_on"}
{"type":"relation","from":"phase-5-data-migration","to":"phase-4-platform-worker","relationType":"depends_on"}
{"type":"relation","from":"phase-6-dashboard-cutover","to":"phase-5-data-migration","relationType":"depends_on"}
{"type":"relation","from":"decision-2-workers-architecture","to":"node2flow-mcp-service","relationType":"influences"}
{"type":"relation","from":"decision-plugin-architecture","to":"node2flow-mcp-service","relationType":"influences"}
{"type":"relation","from":"decision-data-split","to":"phase-5-data-migration","relationType":"influences"}